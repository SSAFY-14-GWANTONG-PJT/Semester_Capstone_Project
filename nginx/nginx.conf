events {
    worker_connections 1024;
}

http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;

    client_max_body_size 20M;

    # 업로드스트림(Upstream) 설정: 도커 컨테이너 이름으로 연결
    upstream frontend {
        server frontend:5173; 
    }

    upstream backend {
        server backend:8000; 
    }
    
    upstream ai {
        server ai:8000;
    }

    server {
        listen 80;
        server_name localhost;

        # 1. 프론트엔드 (기본 접속)
        # http://localhost/ 로 들어오는 모든 요청을 Vue로 보냄
        location / {
            proxy_pass http://frontend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            
            # 웹소켓 지원 
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
        }

        # 2. 백엔드 API
        # http://localhost/api/ 로 시작하는 요청은 Django로 보냄
        location /api/ {
            proxy_pass http://backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

            # 타임아웃 시간을 300초(5분)로 늘립니다.
            proxy_connect_timeout 300;
            proxy_send_timeout 300;
            proxy_read_timeout 300;
            send_timeout 300;
        }

        # 3. Django Admin/Static
        # 관리자 페이지와 정적 파일 처리
        location /admin/ {
            proxy_pass http://backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }
        
        # Django Static 파일 (개발 환경에서는 runserver가 처리하지만 Nginx를 거칠 때 필요할 수 있음)
        location /static/ {
            proxy_pass http://backend;
        }

        # 4. AI API
        # http://localhost/ai/ 로 시작하는 요청은 FastAPI로 보냄
        # 주의: FastAPI 코드에서 root_path="/ai" 설정이 필요할 수 있음
        location /ai/ {
            proxy_pass http://ai/; 
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

            # AI 서버 연결도 길어질 수 있으니 추가
            proxy_connect_timeout 300;
            proxy_send_timeout 300;
            proxy_read_timeout 300;
            send_timeout 300;
        }
    }
}